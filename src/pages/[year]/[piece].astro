---
import '@/styles/global.css'
import { getArtworkPath } from "@/lib/artworks";
import fs from "fs";

// Validate route params
const { year, piece } = Astro.params;
if (!year || !piece) {
  throw new Error("Missing required route parameters");
}

// Check if artwork exists
const artworkPath = getArtworkPath(year, piece);
if (!fs.existsSync(artworkPath)) {
  // Redirect to 404 page
  return Astro.redirect("/404");
}

// Derive base URL from request
const request = Astro.request;
const baseUrl = new URL("/", request.url).origin;

const imageUrl = `${baseUrl}/api/artwork/${year}/${piece}`;
const title = piece.replace(/[-_]/g, " ").replace(/\.[^/.]+$/, "");
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{title} â€” {year} Artwork</title>

    <!-- Open Graph -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:url" content={`${baseUrl}/${year}/${piece}`} />
    <meta property="og:description" content={`Artwork from ${year}: ${title}`} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:image" content={imageUrl} />

    <style>
      .image-container {
        display: inline-block;
        padding: 0.25rem;
        border-radius: 0.75rem;
        background-color: #000000; 
        transition: background-color 0.2s ease;
      }

      .image-container.loaded {
        background-color: #000000; 
      }

      .fade-in {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }

      .fade-in.loaded {
        opacity: 1;
      }
    </style>
  </head>

  <body class="p-8">
    <h1 class="text-4xl text-mustard font-bold mb-1">{title}</h1>

    <p class="mb-4">
      <a class="text-1xl white hover:underline" href={`/${year}`}>Back to {year}</a>
    </p>

    <div class="image-container" id="artwork-container">
      <a href={`/api/artwork/${year}/${piece}`}>
        <img
          src={`/api/artwork/${year}/${piece}`}
          alt={title}
          class="rounded-md fade-in max-w-88"
          onload="this.classList.add('loaded'); document.getElementById('artwork-container').classList.add('loaded');"
        />
      </a>
    </div>
  </body>
</html>
